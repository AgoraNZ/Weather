<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Agora Weather Widget</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      background: #181e2a;
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
      box-sizing: border-box;
    }
    #main-container {
      width: 100vw;
      max-width: 4000px;
      min-width: 1200px;
      height: 300px;
      margin: 0 auto;
      display: flex;
      align-items: stretch;
      background: #181e2a;
      box-shadow: 0 2px 24px #0008;
      border-radius: 18px;
      overflow: hidden;
    }
    #current-block {
      width: 400px;
      min-width: 340px;
      max-width: 440px;
      background: #222c40;
      display: flex;
      flex-direction: row;
      align-items: stretch;
      border-right: 2px solid #232f47;
      box-sizing: border-box;
      padding: 0 10px;
      cursor: pointer;
      position: relative;
    }
    .current-left {
      flex: 0 0 110px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px 0 20px 0;
      gap: 6px;
    }
    .temp {
      font-size: 2.6rem;
      font-weight: 700;
      color: #fff;
      text-shadow: 0 1px 8px #222;
      margin: 0 0 0 0;
      line-height: 1.1;
    }
    .cur-icon {
      width: 106px;
      height: 106px;
      display: block;
      margin-bottom: 4px;
    }
    .current-right {
      flex: 1 1 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding-left: 10px;
      padding-top: 14px;
      height: 100%;
    }
    .weather-now {
      font-size: 1.14rem;
      font-weight: 600;
      margin-bottom: 2px;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .cur-details {
      font-size: 1rem;
      margin: 2px 0 6px 0;
      color: #e4e6f0;
      display: flex;
      flex-direction: row;
      gap: 16px;
    }
    .cur-detail-col {
      display: flex;
      flex-direction: column;
      gap: 1px;
      min-width: 90px;
      font-size: 1rem;
    }
    .ai-advice-box {
      background: #253e62;
      color: #ffd25a;
      border-radius: 7px;
      font-size: 1.05rem;
      margin: 8px 0 0 0;
      padding: 7px 14px 7px 14px;
      font-weight: 600;
      box-shadow: 0 1px 7px #0002;
      line-height: 1.25;
      letter-spacing: 0.01em;
      max-width: 97%;
      text-align: left;
      word-break: break-word;
      min-height: 25px;
      white-space: normal;
      display: inline-block;
    }
    #forecast-block {
      flex: 1;
      display: flex;
      align-items: stretch;
      height: 100%;
      background: #181e2a;
      gap: 11px;
      padding: 11px 14px 10px 14px;
      min-width: 0;
      overflow-x: auto;
      box-sizing: border-box;
    }
    .forecast-card {
      flex: 1 1 0;
      min-width: 115px;
      max-width: 175px;
      background: #232f47;
      border-radius: 15px;
      padding: 13px 9px 10px 9px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      box-shadow: 0 1px 7px #0003;
      color: #fff;
      margin: 0;
      justify-content: flex-start;
      cursor: pointer;
      transition: box-shadow 0.13s;
      position: relative;
      height: 100%;
      overflow: hidden;
    }
    .forecast-card:hover {
      box-shadow: 0 8px 26px #0006;
      background: #27334f;
    }
    .forecast-card .day {
      font-weight: bold;
      font-size: 1.19rem;
      margin-bottom: 5px;
      color: #fff;
      letter-spacing: 0.01em;
      white-space: nowrap;
    }
    .forecast-card .icon {
      font-size: 2.2rem;
      margin-bottom: 5px;
      width: 44px;
      height: 44px;
      display: block;
      align-self: center;
    }
    .forecast-card .desc {
      font-size: 1.08rem;
      color: #c0d2ed;
      margin-bottom: 7px;
      min-height: 18px;
      line-height: 1.07;
      font-weight: 500;
      max-width: 92%;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
    }
    .forecast-card .lowhigh {
      font-size: 1.07rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 1px;
      margin-top: 0.08em;
      line-height: 1.19;
      display: block;
    }
    .forecast-card .wind,
    .forecast-card .precip {
      font-size: 0.96rem;
      color: #aad7ff;
      margin-bottom: 0.11em;
      font-weight: 400;
    }
    .forecast-card .precip { color: #85e7ff; }
    .forecast-card .pasture {
      font-size: 0.98rem;
      color: #ffe180;
      margin-top: 2px;
      font-weight: 500;
      min-height: 15px;
      max-width: 98%;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: normal;
    }
    #popup-bg {
      position: fixed;
      z-index: 99999;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(20, 30, 50, 0.86);
      display: none;
      align-items: center;
      justify-content: center;
    }
    #popup-content {
      background: #232f47;
      border-radius: 18px;
      padding: 26px 34px;
      color: #fff;
      font-size: 1.08rem;
      font-weight: 500;
      max-width: 480px;
      width: 96vw;
      box-shadow: 0 8px 30px #000c;
      line-height: 1.18;
      position: relative;
      text-align: center;
    }
    #popup-close {
      position: absolute;
      top: 5px;
      right: 14px;
      font-size: 2rem;
      color: #aad7ff;
      cursor: pointer;
      background: none;
      border: none;
    }
    #popup-title { font-size: 1.15em; font-weight: bold; margin-bottom: 6px; }
    #popup-summary, #popup-lowhigh, #popup-extra { margin-bottom: 5px; }
    #popup-ai { margin-top: 5px; font-size: 1.01rem; color: #fee680; }
    #popup-hist { margin-top: 7px; color: #aad7ff; font-size: 0.92rem; line-height: 1.08; }
  </style>
</head>
<body>
  <div id="main-container">
    <div id="current-block" tabindex="0">
      <div class="current-left">
        <img id="cur-icon" class="cur-icon" src="" style="display:none;" alt="">
        <div class="temp" id="temp">--°C</div>
      </div>
      <div class="current-right">
        <div class="weather-now" id="weather-text">Loading…</div>
        <div class="cur-details">
          <div class="cur-detail-col">
            <span id="row-highlow">High: --°C<br>Low: --°C</span>
            <span id="row-rain">Rain: -- mm</span>
          </div>
          <div class="cur-detail-col">
            <span id="row-wind">Wind: -- km/h</span>
            <span id="row-gust">Gusts: -- km/h</span>
          </div>
        </div>
        <div class="ai-advice-box" id="todays-advice">Loading today’s AI advice…</div>
      </div>
    </div>
    <div id="forecast-block"></div>
  </div>
  <div id="popup-bg">
    <div id="popup-content">
      <button id="popup-close" onclick="closePopup()">&times;</button>
      <div id="popup-title"></div>
      <div id="popup-summary"></div>
      <div id="popup-lowhigh"></div>
      <div id="popup-extra"></div>
      <div id="popup-ai"></div>
      <div id="popup-hist"></div>
    </div>
  </div>
  <script>
    // --- Pasture & AI advice logic: highly customized for NZ dairy context ---
    function pastureOutlook(temp, precip) {
      if (temp >= 20 && precip >= 5) return "Pasture growth: Excellent – big jump in covers.";
      if (temp > 15 && precip > 2) return "Pasture growth: Good – keep rotation steady.";
      if (temp < 10 && precip < 2) return "Pasture growth: Slow – low soil temp & moisture.";
      if (temp < 6) return "Pasture growth: Minimal – monitor covers closely.";
      if (precip > 20) return "Heavy rain – risk of pugging, shift stock early.";
      return "";
    }
    function agoraAiAdvice(opts) {
      // Add more high-quality, scenario-driven advice here as you did historically
      const advice = [
        { cond: d => d.temp < 5, msg: "Cold snap forecast. Add extra bedding for calves and keep sheds closed overnight." },
        { cond: d => d.gust > 60, msg: "Strong winds expected. Secure doors and check fence lines for damage." },
        { cond: d => d.precip >= 20, msg: "Heavy rain expected. Shift cows off low paddocks and clear drains before milking." },
        { cond: d => d.temp > 28, msg: "High heat today. Delay yarding and provide extra water for cows." },
        { cond: d => d.temp > 24 && d.humidity > 70, msg: "Facial eczema risk – start zinc dosing if not already." },
        { cond: d => d.temp > 20 && d.precip < 2, msg: "Dry day – rotate paddocks early to avoid overgrazing." },
        { cond: d => d.month == 7, msg: "July: Clean and disinfect calf pens ready for calving." },
        { cond: d => d.month == 8, msg: "August: Prepare calving kit (iodine, towels, feeders)." },
        { cond: d => d.month == 11, msg: "November: Prepare magnesium to prevent grass staggers." },
        { cond: d => d.precip > 4, msg: "Showers – hose mud off yard after milking." },
        { cond: d => d.temp < 8 && d.month == 8, msg: "Wet August – use a footbath at shed exit to prevent lameness." },
        { cond: d => d.temp > 18 && d.precip > 6, msg: "Lush pasture – provide hay with grazing to reduce bloat risk." }
      ];
      // Pick the first relevant piece
      const now = new Date(opts.dateISO || Date.now());
      const d = {
        temp: opts.temp, humidity: opts.humidity, gust: opts.gust || 0, precip: opts.precip,
        month: now.getMonth() + 1
      };
      for (let a of advice) if (a.cond(d)) return [a.msg];
      // fallback (random practical dairy advice)
      const fallback = [
        "Sweep steps and plant room entry to reduce slips.",
        "Check gloves and boots are stocked in the shed.",
        "Keep the vat and silo doors clean and shut after use.",
        "Check pasture covers and note areas needing extra rest.",
        "Test tap water temperature before cleaning.",
        "Top up lime in calf pens to keep bedding dry.",
        "Spray weeds along fence lines on fine days."
      ];
      return [fallback[now.getDate() % fallback.length]];
    }
    function iconUrl(icon) {
      if (!icon) return '';
      return https://cdn.aerisapi.com/wxblox/icons/${icon};
    }
    function dayOfWeek(dateISO) {
      return new Date(dateISO).toLocaleDateString('en-NZ', { weekday: 'short' });
    }
    function capitalize(txt) {
      return (txt || '').charAt(0).toUpperCase() + (txt || '').slice(1);
    }
    // --- CURRENT block: show temp/icon/weather/ai advice, update wind/gust with current, but High/Low/Rain from forecast[0] ---
    let latestWind = '--', latestGust = '--';
    fetch('https://data.api.xweather.com/conditions/pws_pukerimu?format=json&plimit=1&filter=1min&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq')
      .then(r => r.json())
      .then(json => {
        if (!json.success) throw new Error('No current conditions');
        const p = json.response[0].periods[0];
        document.getElementById('temp').textContent =
          (typeof p.tempC === 'number') ? ${Math.round(p.tempC)}°C : '--°C';
        const icon = p.icon || '';
        const icElem = document.getElementById('cur-icon');
        if (icon) {
          icElem.src = iconUrl(icon);
          icElem.style.display = '';
        } else {
          icElem.style.display = 'none';
        }
        document.getElementById('weather-text').textContent = capitalize(p.weather) || '--';
        document.getElementById('row-wind').textContent = Wind: ${p.windSpeedKPH != null ? Math.round(p.windSpeedKPH) + ' km/h' : '-- km/h'};
        document.getElementById('row-gust').textContent = Gusts: ${p.windGustKPH != null ? Math.round(p.windGustKPH) + ' km/h' : '-- km/h'};
        latestWind = document.getElementById('row-wind').textContent;
        latestGust = document.getElementById('row-gust').textContent;
        document.getElementById('todays-advice').textContent = agoraAiAdvice({
          temp: p.tempC,
          humidity: p.humidity,
          gust: p.windGustKPH,
          precip: p.precipMM,
          dateISO: p.dateTimeISO
        })[0];
        // Popup on click for current block
        document.getElementById('current-block').onclick = () => openPopup({
          title: "Current Conditions",
          lowhigh: document.getElementById('row-highlow').innerHTML,
          extra: ${latestWind}<br>${latestGust}<br>${document.getElementById('row-rain').textContent},
          ai: agoraAiAdvice({
            temp: p.tempC,
            humidity: p.humidity,
            gust: p.windGustKPH,
            precip: p.precipMM,
            dateISO: p.dateTimeISO
          })[0]
        });
      });

    // --- FORECAST: today[0] used for high/low/rain in current, cards for days 1–6 ---
    fetch('https://data.api.xweather.com/forecasts/pws_pukerimu?format=json&plimit=8&fields=periods.timestamp,periods.dateTimeISO,periods.tempC,periods.weather,periods.icon,periods.maxTempC,periods.minTempC,periods.humidity,periods.precipMM,periods.windSpeedKPH,periods.windGustKPH,periods.dewpointC,periods.summary&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq')
      .then(r => r.json())
      .then(json => {
        if (!json.success) throw new Error('No forecast');
        const fc = json.response[0].periods || [];
        // Set high/low/rain for CURRENT box from today's forecast
        if (fc.length > 0) {
          const today = fc[0];
          document.getElementById('row-highlow').innerHTML =
            High: ${today.maxTempC != null ? Math.round(today.maxTempC) + '°C' : '--°C'}<br> +
            Low: ${today.minTempC != null ? Math.round(today.minTempC) + '°C' : '--°C'};
          document.getElementById('row-rain').textContent =
            Rain: ${today.precipMM != null ? today.precipMM + ' mm' : '-- mm'};
        }
        // Render forecast cards, skipping today (index 0)
        const fcDom = document.getElementById('forecast-block');
        fcDom.innerHTML = "";
        for (let i = 1; i < fc.length && i <= 6; ++i) {
          const p = fc[i];
          const advice = agoraAiAdvice({
            temp: p.tempC || p.maxTempC,
            humidity: p.humidity,
            gust: p.windGustKPH,
            precip: p.precipMM,
            dateISO: p.dateTimeISO
          })[0];
          const pasture = pastureOutlook(p.tempC || p.maxTempC, p.precipMM);
          fcDom.innerHTML += 
            <div class="forecast-card" tabindex="0" onclick="openPopup({
                title: '${dayOfWeek(p.dateTimeISO)}',
                lowhigh: 'High: ${Math.round(p.maxTempC)}°C<br>Low: ${Math.round(p.minTempC)}°C',
                extra: 'Wind: ${Math.round(p.windSpeedKPH || 0)} km/h<br>Rain: ${p.precipMM || 0} mm',
                ai: '${advice}${pasture ? <br><span style=&quot;color:#ffe180&quot;>${pasture}</span> : ''}'
              })">
              <div class="day">${dayOfWeek(p.dateTimeISO)}</div>
              <img class="icon" src="${iconUrl(p.icon)}" alt="" width="44" height="44">
              <div class="desc">${capitalize(p.weather || '')}</div>
              <div class="lowhigh">High: ${Math.round(p.maxTempC)}°C<br>Low: ${Math.round(p.minTempC)}°C</div>
              <div class="wind">Wind: ${Math.round(p.windSpeedKPH || 0)} km/h</div>
              <div class="precip">Rain: ${p.precipMM || 0} mm</div>
              <div class="pasture">${pasture}</div>
            </div>
          ;
        }
      });

    function openPopup(opts) {
      document.getElementById('popup-title').textContent = opts.title || "";
      document.getElementById('popup-summary').textContent = opts.summary || "";
      document.getElementById('popup-lowhigh').innerHTML = opts.lowhigh || "";
      document.getElementById('popup-extra').innerHTML = opts.extra || "";
      document.getElementById('popup-ai').innerHTML = opts.ai || "";
      document.getElementById('popup-hist').innerHTML = opts.hist || "";
      document.getElementById('popup-bg').style.display = 'flex';
    }
    function closePopup() {
      document.getElementById('popup-bg').style.display = 'none';
    }
    document.getElementById('popup-bg').onclick = (e) => {
      if (e.target === e.currentTarget) closePopup();
    };
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closePopup();
    });
  </script>
</body>
</html>
